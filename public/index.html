<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TSI Fit Score Engine</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f7fa;
      color: #333;
      min-height: 100vh;
    }
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 240px;
      background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
      padding: 20px 0;
      color: white;
      z-index: 100;
    }
    .logo {
      padding: 0 20px 30px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }
    .logo h1 {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
    }
    .logo span {
      font-size: 12px;
      color: #8b8fa3;
    }
    .nav-item {
      display: flex;
      align-items: center;
      padding: 14px 20px;
      color: #8b8fa3;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }
    .nav-item:hover {
      background: rgba(255,255,255,0.05);
      color: #fff;
    }
    .nav-item.active {
      background: rgba(79, 70, 229, 0.2);
      color: #fff;
      border-left-color: #4f46e5;
    }
    .nav-item svg {
      width: 20px;
      height: 20px;
      margin-right: 12px;
    }
    .main-content {
      margin-left: 240px;
      padding: 30px;
      min-height: 100vh;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .header h2 {
      font-size: 24px;
      color: #1a1a2e;
    }
    .header-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    select, button, input[type="text"], input[type="password"] {
      padding: 10px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }
    input[type="text"], input[type="password"] {
      cursor: text;
      min-width: 200px;
    }
    button {
      background: #4f46e5;
      color: white;
      border: none;
      font-weight: 500;
    }
    button:hover {
      background: #4338ca;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    button.secondary {
      background: #6b7280;
    }
    button.secondary:hover {
      background: #4b5563;
    }
    button.success {
      background: #10b981;
    }
    button.success:hover {
      background: #059669;
    }
    button.danger {
      background: #ef4444;
    }
    button.danger:hover {
      background: #dc2626;
    }
    button.outline {
      background: transparent;
      border: 1px solid #ddd;
      color: #374151;
    }
    button.outline:hover {
      background: #f3f4f6;
    }
    .api-key-bar {
      background: white;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .api-key-bar label {
      font-weight: 600;
      color: #374151;
    }
    .api-key-bar input {
      flex: 1;
      max-width: 350px;
    }
    .api-key-bar .status {
      margin-left: auto;
      font-size: 13px;
    }
    .api-key-bar .status.connected {
      color: #10b981;
    }
    .api-key-bar .status.disconnected {
      color: #ef4444;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stat-card h3 {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
      color: #1a1a2e;
    }
    .stat-card .value.green { color: #10b981; }
    .stat-card .value.blue { color: #3b82f6; }
    .stat-card .value.purple { color: #8b5cf6; }
    .stat-card .value.orange { color: #f97316; }
    .stat-card .value.red { color: #ef4444; }
    .card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .card h3 {
      font-size: 18px;
      margin-bottom: 20px;
      color: #1a1a2e;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .charts-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .chart-container {
      position: relative;
      height: 280px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #6b7280;
      font-weight: 600;
    }
    td {
      font-size: 14px;
    }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge.disqualified { background: #fee2e2; color: #dc2626; }
    .badge.mql { background: #fef3c7; color: #d97706; }
    .badge.high-fit { background: #d1fae5; color: #059669; }
    .badge.premium { background: #dbeafe; color: #2563eb; }
    .badge.success { background: #d1fae5; color: #059669; }
    .badge.error { background: #fee2e2; color: #dc2626; }
    .badge.warning { background: #fef3c7; color: #d97706; }
    .badge.info { background: #dbeafe; color: #2563eb; }
    .progress-bar {
      width: 80px;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }
    .progress-bar .fill {
      height: 100%;
      background: #10b981;
      border-radius: 3px;
    }
    .loading {
      text-align: center;
      padding: 60px;
      color: #6b7280;
    }
    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top-color: #4f46e5;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .error-message {
      text-align: center;
      padding: 40px;
      color: #ef4444;
      background: #fef2f2;
      border-radius: 8px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
    }
    .form-group input {
      width: 100%;
    }
    .form-group small {
      color: #6b7280;
      font-size: 12px;
      margin-top: 4px;
      display: block;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .status-dot.green { background: #10b981; }
    .status-dot.red { background: #ef4444; }
    .status-dot.yellow { background: #f59e0b; }
    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    .log-entry {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      padding: 8px 12px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      gap: 12px;
    }
    .log-entry:hover {
      background: #f9fafb;
    }
    .log-entry .timestamp {
      color: #6b7280;
      white-space: nowrap;
    }
    .log-entry .level {
      width: 50px;
      font-weight: 600;
    }
    .log-entry .level.info { color: #3b82f6; }
    .log-entry .level.warn { color: #f59e0b; }
    .log-entry .level.error { color: #ef4444; }
    .log-entry .message {
      flex: 1;
      word-break: break-word;
    }
    .logs-container {
      max-height: 500px;
      overflow-y: auto;
      background: #fafafa;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .enrichment-result {
      background: #f9fafb;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    .enrichment-result h4 {
      margin-bottom: 15px;
      color: #1a1a2e;
    }
    .result-section {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e5e7eb;
    }
    .result-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .result-section h5 {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
    }
    .result-item {
      background: white;
      padding: 10px;
      border-radius: 6px;
    }
    .result-item .label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 2px;
    }
    .result-item .value {
      font-weight: 600;
      color: #1a1a2e;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 15px;
    }
    .checkbox-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .selection-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #eef2ff;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    @media (max-width: 1024px) {
      .sidebar {
        width: 200px;
      }
      .main-content {
        margin-left: 200px;
      }
      .charts-row {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 768px) {
      .sidebar {
        position: relative;
        width: 100%;
      }
      .main-content {
        margin-left: 0;
      }
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    /* Login overlay */
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .login-overlay.hidden {
      display: none;
    }
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    .login-box h1 {
      font-size: 24px;
      color: #1a1a2e;
      margin-bottom: 8px;
    }
    .login-box p {
      color: #6b7280;
      margin-bottom: 24px;
      font-size: 14px;
    }
    .login-box input[type="email"] {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
    }
    .login-box input[type="email"]:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .login-box button {
      width: 100%;
      padding: 14px;
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .login-box button:hover {
      background: #4338ca;
    }
    .login-error {
      color: #ef4444;
      font-size: 13px;
      margin-top: 12px;
      display: none;
    }
    .login-error.show {
      display: block;
    }
    .app-container {
      display: none;
    }
    .app-container.visible {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Login Overlay -->
  <div id="loginOverlay" class="login-overlay">
    <div class="login-box">
      <h1>TSI Fit Score</h1>
      <p>Enter your authorized email to access the dashboard</p>
      <form onsubmit="handleLogin(event)">
        <input type="email" id="loginEmail" placeholder="Enter your email address" autocomplete="email" required>
        <button type="submit">Access Dashboard</button>
      </form>
      <div id="loginError" class="login-error">Invalid email address. Access denied.</div>
    </div>
  </div>

  <!-- App Container (hidden until login) -->
  <div id="appContainer" class="app-container">
  <nav class="sidebar">
    <div class="logo">
      <h1>TSI Fit Score</h1>
      <span>Lead Enrichment Engine</span>
    </div>
    <div class="nav-item active" onclick="switchTab('dashboard')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
      Dashboard
    </div>
    <div class="nav-item" onclick="switchTab('enrich')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
      Manual Enrichment
    </div>
    <div class="nav-item" onclick="switchTab('unenriched')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
      Unenriched Leads
    </div>
    <div class="nav-item" onclick="switchTab('setup')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
      Setup & Logs
    </div>
  </nav>

  <main class="main-content">
    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content active">
      <div class="header">
        <h2>Dashboard</h2>
        <div class="header-controls">
          <select id="dateRange" onchange="loadDashboard()">
            <option value="this_month" selected>This Month</option>
            <option value="last_month">Last Month</option>
            <option value="this_quarter">This Quarter</option>
            <option value="last_7_days">Last 7 Days</option>
            <option value="last_30_days">Last 30 Days</option>
            <option value="last_90_days">Last 90 Days</option>
            <option value="this_year">This Year</option>
          </select>
          <button onclick="loadDashboard()">Refresh</button>
        </div>
      </div>
      <div id="dashboard-content">
        <div class="loading">Loading dashboard data</div>
      </div>
    </div>

    <!-- Manual Enrichment Tab -->
    <div id="enrich-tab" class="tab-content">
      <div class="header">
        <h2>Manual Lead Enrichment</h2>
      </div>
      <div class="card">
        <h3>Enrich a Single Lead</h3>
        <p style="color: #6b7280; margin-bottom: 20px;">Enter a Salesforce Lead ID to fetch lead data and run enrichment. The system will update the Fit Score in Salesforce automatically.</p>
        <div class="form-group">
          <label for="leadId">Salesforce Lead ID</label>
          <input type="text" id="leadId" placeholder="00Q..." style="max-width: 400px;">
          <small>Example: 00Q5e000001ABC123</small>
        </div>
        <div class="checkbox-row">
          <input type="checkbox" id="updateSalesforce" checked>
          <label for="updateSalesforce">Update Salesforce with enrichment results</label>
        </div>
        <div style="display: flex; gap: 12px;">
          <button onclick="lookupLead()">Lookup Lead</button>
          <button class="success" onclick="enrichLead()" id="enrichBtn">Enrich Lead</button>
        </div>
        <div id="enrichment-result"></div>
      </div>

      <div class="card" style="margin-top: 20px;">
        <h3>Bulk Enrich Multiple Leads</h3>
        <p style="color: #6b7280; margin-bottom: 20px;">Paste multiple Salesforce Lead IDs (one per line) to enrich them in bulk. Maximum 10 leads per batch.</p>
        <div class="form-group">
          <label for="bulkLeadIds">Salesforce Lead IDs (one per line)</label>
          <textarea id="bulkLeadIds" rows="6" style="width: 100%; max-width: 500px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: monospace; font-size: 13px;" placeholder="00Q5e000001ABC123&#10;00Q5e000001DEF456&#10;00Q5e000001GHI789"></textarea>
          <small>Enter up to 10 Lead IDs, one per line</small>
        </div>
        <div class="checkbox-row">
          <input type="checkbox" id="bulkUpdateSalesforce" checked>
          <label for="bulkUpdateSalesforce">Update Salesforce with enrichment results</label>
        </div>
        <div style="display: flex; gap: 12px;">
          <button class="success" onclick="enrichBulkLeads()" id="bulkEnrichBtn">Enrich All Leads</button>
        </div>
        <div id="bulk-enrichment-result"></div>
      </div>
    </div>

    <!-- Unenriched Leads Tab -->
    <div id="unenriched-tab" class="tab-content">
      <div class="header">
        <h2>Unenriched Leads</h2>
        <div class="header-controls">
          <select id="unenrichedDateRange" onchange="loadUnenrichedLeads(1)">
            <option value="this_month" selected>This Month</option>
            <option value="last_month">Last Month</option>
            <option value="this_quarter">This Quarter</option>
            <option value="last_7_days">Last 7 Days</option>
            <option value="last_30_days">Last 30 Days</option>
            <option value="last_90_days">Last 90 Days</option>
            <option value="this_year">This Year</option>
          </select>
          <button onclick="loadUnenrichedLeads(1)">Refresh</button>
        </div>
      </div>
      <div id="unenriched-content">
        <div class="loading">Loading unenriched leads</div>
      </div>
    </div>

    <!-- Setup Tab -->
    <div id="setup-tab" class="tab-content">
      <div class="header">
        <h2>Setup & Configuration</h2>
        <div class="header-controls">
          <button onclick="loadSetup()">Refresh Status</button>
        </div>
      </div>

      <div id="setup-content">
        <div class="loading">Loading system status</div>
      </div>

      <div class="card" style="margin-top: 20px;">
        <h3>Workato Integration</h3>
        <p style="color: #6b7280; margin-bottom: 15px;">Configure your Workato webhook URL for sending enrichment results back to your automation workflow.</p>
        <div class="form-group">
          <label for="workatoWebhookUrl">Workato Webhook URL</label>
          <div style="display: flex; gap: 12px; align-items: flex-start;">
            <input type="text" id="workatoWebhookUrl" placeholder="https://www.workato.com/webhooks/rest/..." style="flex: 1;">
            <button class="secondary" onclick="saveWorkatoWebhook()">Save</button>
            <button class="outline" onclick="testWorkatoWebhook()">Test</button>
          </div>
          <small>This URL receives enrichment results when processing is complete. Get this from your Workato recipe's webhook trigger.</small>
        </div>
        <div id="webhookTestResult"></div>
      </div>

      <div class="card" style="margin-top: 20px;">
        <h3>
          Application Logs
          <div style="display: flex; gap: 10px;">
            <select id="logLevel" onchange="loadLogs()">
              <option value="">All Levels</option>
              <option value="info">Info</option>
              <option value="warn">Warnings</option>
              <option value="error">Errors</option>
            </select>
            <button class="outline" onclick="loadLogs()">Refresh</button>
          </div>
        </h3>
        <div id="logs-content" class="logs-container">
          <div class="loading">Loading logs</div>
        </div>
      </div>
    </div>
  </main>
  </div> <!-- End of appContainer -->

  <script>
    let scoreChart, sourceChart, activityChart;
    let selectedLeads = new Set();

    // Pagination state for unenriched leads
    let unenrichedPagination = {
      currentPage: 1,
      pageSize: 100,
      totalCount: 0,
      totalPages: 0
    };

    // Authorized email for login
    const AUTHORIZED_EMAIL = 'johan.garcia@townsquaremedia.com';

    // Check if user is already logged in
    function checkAuth() {
      const isAuthenticated = sessionStorage.getItem('tsi_authenticated') === 'true';
      if (isAuthenticated) {
        showApp();
        return true;
      }
      return false;
    }

    // Handle login form submission
    function handleLogin(event) {
      event.preventDefault();
      const email = document.getElementById('loginEmail').value.trim().toLowerCase();
      const errorDiv = document.getElementById('loginError');

      if (email === AUTHORIZED_EMAIL.toLowerCase()) {
        sessionStorage.setItem('tsi_authenticated', 'true');
        errorDiv.classList.remove('show');
        showApp();
      } else {
        errorDiv.classList.add('show');
      }
    }

    // Show the main app
    function showApp() {
      document.getElementById('loginOverlay').classList.add('hidden');
      document.getElementById('appContainer').classList.add('visible');
      loadDashboard();
    }

    // Load dashboard on page load (only if authenticated)
    document.addEventListener('DOMContentLoaded', async () => {
      if (!checkAuth()) {
        // Focus on email input if not authenticated
        document.getElementById('loginEmail').focus();
      }
    });

    // Calculate date range based on selection
    function getDateRange() {
      const selection = document.getElementById('dateRange').value;
      const now = new Date();
      let startDate, endDate;

      switch (selection) {
        case 'this_month':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          endDate = now;
          break;
        case 'last_month':
          startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
          endDate = new Date(now.getFullYear(), now.getMonth(), 0);
          break;
        case 'this_quarter':
          const quarter = Math.floor(now.getMonth() / 3);
          startDate = new Date(now.getFullYear(), quarter * 3, 1);
          endDate = now;
          break;
        case 'last_7_days':
          startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          endDate = now;
          break;
        case 'last_30_days':
          startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
          endDate = now;
          break;
        case 'last_90_days':
          startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
          endDate = now;
          break;
        case 'this_year':
          startDate = new Date(now.getFullYear(), 0, 1);
          endDate = now;
          break;
        default:
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          endDate = now;
      }

      return {
        startDate: startDate.toISOString().split('T')[0],
        endDate: endDate.toISOString().split('T')[0]
      };
    }

    // Tab switching
    function switchTab(tab) {
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
      document.getElementById(`${tab}-tab`).classList.add('active');

      if (tab === 'dashboard') loadDashboard();
      else if (tab === 'unenriched') loadUnenrichedLeads();
      else if (tab === 'setup') { loadSetup(); loadLogs(); }
    }

    // Fetch helper (no auth needed for dashboard endpoints)
    async function fetchApi(url, options = {}) {
      try {
        const response = await fetch(url, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            ...(options.headers || {}),
          },
        });
        return response;
      } catch (error) {
        console.error('Fetch error:', url, error);
        throw new Error(`Network error: ${error.message}`);
      }
    }

    // Parse API response with better error handling
    async function parseResponse(response) {
      const text = await response.text();
      try {
        return JSON.parse(text);
      } catch {
        throw new Error(text || `HTTP ${response.status}: ${response.statusText}`);
      }
    }

    // Dashboard
    async function loadDashboard() {
      const dateRange = getDateRange();
      const content = document.getElementById('dashboard-content');
      content.innerHTML = '<div class="loading">Connecting to Salesforce and loading dashboard data</div>';

      try {
        const [statsRes, dbStatsRes] = await Promise.all([
          fetchApi(`/api/dashboard/stats?startDate=${dateRange.startDate}&endDate=${dateRange.endDate}`),
          fetchApi('/api/setup/database-stats')
        ]);

        if (!statsRes.ok) {
          const errorData = await parseResponse(statsRes);
          throw new Error(errorData.error || `HTTP ${statsRes.status}: Failed to fetch stats`);
        }

        const stats = await parseResponse(statsRes);
        const dbStats = dbStatsRes.ok ? await parseResponse(dbStatsRes) : null;

        renderDashboard(stats, dbStats, dateRange);
      } catch (error) {
        console.error('Dashboard load error:', error);
        content.innerHTML = `<div class="error-message">
          <strong>Connection Error</strong><br>
          ${escapeHtml(error.message)}<br><br>
          <small>Check Setup & Logs tab for more details</small>
        </div>`;
      }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function renderDashboard(stats, dbStats, dateRange) {
      const content = document.getElementById('dashboard-content');
      const dateRangeLabel = `${new Date(dateRange.startDate).toLocaleDateString()} - ${new Date(dateRange.endDate).toLocaleDateString()}`;

      // Build setup warnings if needed
      let setupWarnings = '';
      const warnings = [];

      if (stats.setupRequired && stats.setupRequired.length > 0) {
        warnings.push(...stats.setupRequired);
      }
      if (dbStats && dbStats.setupRequired) {
        warnings.push(dbStats.setupRequired);
      }
      if (!stats.customFieldsAvailable) {
        warnings.push('Salesforce custom fields not detected - showing basic lead stats only');
      }
      if (dbStats && dbStats.tableExists === false) {
        warnings.push('Database tables not created - local enrichment storage unavailable');
      }

      if (warnings.length > 0) {
        setupWarnings = `
          <div class="setup-warning" style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
            <strong style="color: #92400e;">Setup Required:</strong>
            <ul style="margin: 10px 0 0 20px; color: #92400e;">
              ${warnings.map(w => `<li>${escapeHtml(w)}</li>`).join('')}
            </ul>
            <p style="margin-top: 10px; color: #92400e; font-size: 13px;">
              See the <a href="#" onclick="switchTab('setup'); return false;" style="color: #b45309; text-decoration: underline;">Setup & Logs</a> tab for more details.
            </p>
          </div>
        `;
      }

      content.innerHTML = `
        ${setupWarnings}
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Total Leads</h3>
            <div class="value">${stats.totalLeads.toLocaleString()}</div>
          </div>
          <div class="stat-card">
            <h3>Enriched</h3>
            <div class="value blue">${stats.enrichedLeads.toLocaleString()}</div>
          </div>
          <div class="stat-card">
            <h3>Unenriched</h3>
            <div class="value orange">${stats.unenrichedLeads.toLocaleString()}</div>
          </div>
          <div class="stat-card">
            <h3>Enrichment Rate</h3>
            <div class="value green">${stats.enrichmentRate.toFixed(1)}%</div>
          </div>
          <div class="stat-card">
            <h3>Avg Fit Score</h3>
            <div class="value purple">${stats.avgFitScore.toFixed(1)}</div>
          </div>
          ${dbStats ? `
          <div class="stat-card">
            <h3>Local DB Records</h3>
            <div class="value">${parseInt(dbStats.stats.total_enrichments).toLocaleString()}</div>
          </div>
          ` : ''}
        </div>

        <div class="charts-row">
          <div class="card">
            <h3>Score Distribution</h3>
            <div class="chart-container">
              <canvas id="scoreChart"></canvas>
            </div>
          </div>
          <div class="card">
            <h3>Leads by Source</h3>
            <div class="chart-container">
              <canvas id="sourceChart"></canvas>
            </div>
          </div>
        </div>

        ${dbStats && dbStats.recentActivity.length > 0 ? `
        <div class="card">
          <h3>Enrichment Activity (Last 30 Days)</h3>
          <div class="chart-container" style="height: 200px;">
            <canvas id="activityChart"></canvas>
          </div>
        </div>
        ` : ''}

        <div class="card">
          <h3>Lead Source Breakdown</h3>
          <table>
            <thead>
              <tr>
                <th>Lead Source</th>
                <th>Total</th>
                <th>Enriched</th>
                <th>Rate</th>
                <th>Avg Score</th>
              </tr>
            </thead>
            <tbody>
              ${stats.byLeadSource.slice(0, 10).map(source => `
                <tr>
                  <td><strong>${source.leadSource}</strong></td>
                  <td>${source.totalLeads.toLocaleString()}</td>
                  <td>${source.enrichedLeads.toLocaleString()}</td>
                  <td>
                    <div class="progress-bar">
                      <div class="fill" style="width: ${source.enrichmentRate}%"></div>
                    </div>
                    ${source.enrichmentRate.toFixed(0)}%
                  </td>
                  <td>${source.avgFitScore.toFixed(1)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      renderScoreChart(stats.scoreDistribution);
      renderSourceChart(stats.byLeadSource);
      if (dbStats && dbStats.recentActivity.length > 0) {
        renderActivityChart(dbStats.recentActivity);
      }
    }

    function renderScoreChart(distribution) {
      const ctx = document.getElementById('scoreChart');
      if (!ctx) return;
      if (scoreChart) scoreChart.destroy();

      // Sort by score value (0-5)
      const sortedDistribution = [...distribution].sort((a, b) => a.score - b.score);

      // Color gradient from red (low scores) to green (high scores)
      const colors = ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#10b981'];

      scoreChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sortedDistribution.map(d => d.score.toString()),
          datasets: [{
            label: 'Total Leads',
            data: sortedDistribution.map(d => d.count),
            backgroundColor: sortedDistribution.map((d, i) => colors[i] || '#4f46e5'),
            borderRadius: 6,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#f0f0f0' },
              title: { display: true, text: 'Total Leads' }
            },
            x: {
              grid: { display: false },
              title: { display: true, text: 'Score' }
            }
          }
        }
      });
    }

    function renderSourceChart(sources) {
      const ctx = document.getElementById('sourceChart');
      if (!ctx) return;
      if (sourceChart) sourceChart.destroy();

      const topSources = sources.slice(0, 6);
      const colors = ['#4f46e5', '#7c3aed', '#ec4899', '#f43f5e', '#f97316', '#22c55e'];

      sourceChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: topSources.map(s => s.leadSource),
          datasets: [{
            data: topSources.map(s => s.totalLeads),
            backgroundColor: colors,
            borderWidth: 0,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right', labels: { padding: 12, usePointStyle: true } }
          }
        }
      });
    }

    function renderActivityChart(activity) {
      const ctx = document.getElementById('activityChart');
      if (!ctx) return;
      if (activityChart) activityChart.destroy();

      const sorted = [...activity].reverse();

      activityChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: sorted.map(a => new Date(a.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
          datasets: [{
            label: 'Enrichments',
            data: sorted.map(a => parseInt(a.count)),
            borderColor: '#4f46e5',
            backgroundColor: 'rgba(79, 70, 229, 0.1)',
            fill: true,
            tension: 0.3,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
            x: { grid: { display: false } }
          }
        }
      });
    }

    // Manual Enrichment
    async function lookupLead() {
      const leadId = document.getElementById('leadId').value.trim();
      if (!leadId) {
        alert('Please enter a Salesforce Lead ID');
        return;
      }

      const resultDiv = document.getElementById('enrichment-result');
      resultDiv.innerHTML = '<div class="loading">Looking up lead</div>';

      try {
        const response = await fetchApi(`/api/lead/${leadId}`);
        const data = await response.json();

        if (!data.salesforce && !data.localEnrichment) {
          resultDiv.innerHTML = '<div class="error-message">Lead not found</div>';
          return;
        }

        let html = '<div class="enrichment-result">';

        if (data.salesforce) {
          html += `
            <div class="result-section">
              <h5>Salesforce Lead Data</h5>
              <div class="result-grid">
                <div class="result-item"><div class="label">Company</div><div class="value">${data.salesforce.Company || '-'}</div></div>
                <div class="result-item"><div class="label">Website</div><div class="value">${data.salesforce.Website || '-'}</div></div>
                <div class="result-item"><div class="label">Phone</div><div class="value">${data.salesforce.Phone || '-'}</div></div>
                <div class="result-item"><div class="label">Location</div><div class="value">${[data.salesforce.City, data.salesforce.State].filter(Boolean).join(', ') || '-'}</div></div>
                <div class="result-item"><div class="label">Lead Source</div><div class="value">${data.salesforce.LeadSource || '-'}</div></div>
                <div class="result-item"><div class="label">Status</div><div class="value">${data.salesforce.Status || '-'}</div></div>
                ${data.salesforce.Score__c !== null && data.salesforce.Score__c !== undefined ? `<div class="result-item"><div class="label">Current Score</div><div class="value">${data.salesforce.Score__c}</div></div>` : ''}
              </div>
            </div>
          `;
        }

        if (data.localEnrichment) {
          html += `
            <div class="result-section">
              <h5>Last Local Enrichment (${new Date(data.localEnrichment.created_at).toLocaleString()})</h5>
              <div class="result-grid">
                <div class="result-item"><div class="label">Fit Score</div><div class="value">${data.localEnrichment.fit_score ?? '-'}</div></div>
                <div class="result-item"><div class="label">Status</div><div class="value">${data.localEnrichment.enrichment_status || '-'}</div></div>
              </div>
            </div>
          `;
        }

        html += '</div>';
        resultDiv.innerHTML = html;
      } catch (error) {
        resultDiv.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
      }
    }

    async function enrichLead() {
      const leadId = document.getElementById('leadId').value.trim();
      if (!leadId) {
        alert('Please enter a Salesforce Lead ID');
        return;
      }

      const updateSalesforce = document.getElementById('updateSalesforce').checked;
      const btn = document.getElementById('enrichBtn');
      const resultDiv = document.getElementById('enrichment-result');

      btn.disabled = true;
      btn.textContent = 'Enriching...';
      resultDiv.innerHTML = '<div class="loading">Running enrichment (this may take 30-60 seconds)</div>';

      try {
        const response = await fetchApi('/api/enrich-by-id', {
          method: 'POST',
          body: JSON.stringify({
            salesforce_lead_id: leadId,
            update_salesforce: updateSalesforce
          })
        });

        const data = await response.json();

        if (!data.success) {
          resultDiv.innerHTML = `<div class="error-message">Enrichment failed: ${data.error}</div>`;
          return;
        }

        resultDiv.innerHTML = `
          <div class="enrichment-result">
            <h4 style="color: #10b981;">Enrichment Completed Successfully</h4>

            <div class="result-section">
              <h5>Fit Score Result</h5>
              <div class="result-grid">
                <div class="result-item"><div class="label">Fit Score</div><div class="value" style="font-size: 24px; color: #4f46e5;">${data.enrichment.fit_score}</div></div>
                <div class="result-item"><div class="label">Duration</div><div class="value">${(data.duration_ms / 1000).toFixed(1)}s</div></div>
                <div class="result-item"><div class="label">Salesforce Updated</div><div class="value">${data.salesforce_updated ? '<span class="badge success">Yes</span>' : '<span class="badge warning">No</span>'}</div></div>
              </div>
            </div>

            <div class="result-section">
              <h5>Lead Info</h5>
              <div class="result-grid">
                <div class="result-item"><div class="label">Company</div><div class="value">${data.lead.company || '-'}</div></div>
                <div class="result-item"><div class="label">Website</div><div class="value">${data.lead.website || '-'}</div></div>
                <div class="result-item"><div class="label">Phone</div><div class="value">${data.lead.phone || '-'}</div></div>
                <div class="result-item"><div class="label">Location</div><div class="value">${[data.lead.city, data.lead.state].filter(Boolean).join(', ') || '-'}</div></div>
              </div>
            </div>

            ${data.enrichment.google_places ? `
            <div class="result-section">
              <h5>Google Places Data</h5>
              <div class="result-grid">
                <div class="result-item"><div class="label">Rating</div><div class="value">${data.enrichment.google_places.gmb_rating ?? '-'}</div></div>
                <div class="result-item"><div class="label">Reviews</div><div class="value">${data.enrichment.google_places.gmb_review_count ?? '-'}</div></div>
                <div class="result-item"><div class="label">Operational</div><div class="value">${data.enrichment.google_places.gmb_is_operational ? 'Yes' : 'No'}</div></div>
              </div>
            </div>
            ` : ''}

            ${data.enrichment.website_tech ? `
            <div class="result-section">
              <h5>Website Tech</h5>
              <div class="result-grid">
                <div class="result-item"><div class="label">Meta Pixel</div><div class="value">${data.enrichment.website_tech.has_meta_pixel ? 'Yes' : 'No'}</div></div>
                <div class="result-item"><div class="label">GA4</div><div class="value">${data.enrichment.website_tech.has_ga4 ? 'Yes' : 'No'}</div></div>
                <div class="result-item"><div class="label">Google Ads</div><div class="value">${data.enrichment.website_tech.has_google_ads_tag ? 'Yes' : 'No'}</div></div>
                <div class="result-item"><div class="label">HubSpot</div><div class="value">${data.enrichment.website_tech.has_hubspot ? 'Yes' : 'No'}</div></div>
                <div class="result-item"><div class="label">Pixel Count</div><div class="value">${data.enrichment.website_tech.pixel_count ?? 0}</div></div>
              </div>
            </div>
            ` : ''}

            ${data.enrichment.clay ? `
            <div class="result-section">
              <h5>Clay Data</h5>
              <div class="result-grid">
                <div class="result-item"><div class="label">Employees</div><div class="value">${data.enrichment.clay.employee_estimate ?? '-'}</div></div>
                <div class="result-item"><div class="label">Years in Business</div><div class="value">${data.enrichment.clay.years_in_business ?? '-'}</div></div>
              </div>
            </div>
            ` : ''}

            <div class="result-section">
              <h5>Salesforce Update Summary</h5>
              <div class="result-grid">
                <div class="result-item">
                  <div class="label">Has Website</div>
                  <div class="value">${data.enrichment.website_tech ? '<span class="badge success">Yes</span>' : '<span class="badge warning">No</span>'}</div>
                </div>
                <div class="result-item">
                  <div class="label">Has GMB</div>
                  <div class="value">${data.enrichment.google_places ? '<span class="badge success">Yes</span>' : '<span class="badge warning">No</span>'}</div>
                </div>
                <div class="result-item">
                  <div class="label">Address Updated</div>
                  <div class="value">${(data.enrichment.google_places?.gmb_city || data.enrichment.google_places?.gmb_state) ? '<span class="badge success">Yes</span>' : '<span class="badge info">No</span>'}</div>
                </div>
                <div class="result-item">
                  <div class="label">GMB Reviews</div>
                  <div class="value">${data.enrichment.google_places?.gmb_review_count != null
                    ? (data.enrichment.google_places.gmb_review_count >= 14
                      ? '<span class="badge success">14+ reviews</span>'
                      : '<span class="badge warning">Below 14</span>')
                    : '<span class="badge info">N/A</span>'}</div>
                </div>
              </div>
            </div>

            <div class="result-section">
              <h5>Score Breakdown</h5>
              <pre style="background: #f9fafb; padding: 12px; border-radius: 6px; font-size: 12px; overflow-x: auto;">${JSON.stringify(data.enrichment.score_breakdown, null, 2)}</pre>
            </div>
          </div>
        `;
      } catch (error) {
        resultDiv.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Enrich Lead';
      }
    }

    // Bulk Enrichment from Manual Enrichment tab
    async function enrichBulkLeads() {
      const textarea = document.getElementById('bulkLeadIds');
      const lines = textarea.value.trim().split('\n').filter(line => line.trim());

      if (lines.length === 0) {
        alert('Please enter at least one Salesforce Lead ID');
        return;
      }

      if (lines.length > 10) {
        alert('Maximum 10 leads per batch. Please reduce the number of Lead IDs.');
        return;
      }

      const leadIds = lines.map(line => line.trim()).filter(id => id.startsWith('00Q'));
      if (leadIds.length === 0) {
        alert('No valid Salesforce Lead IDs found. Lead IDs should start with "00Q".');
        return;
      }

      const updateSalesforce = document.getElementById('bulkUpdateSalesforce').checked;
      const btn = document.getElementById('bulkEnrichBtn');
      const resultDiv = document.getElementById('bulk-enrichment-result');

      btn.disabled = true;
      btn.textContent = 'Enriching...';
      resultDiv.innerHTML = '<div class="loading">Processing enrichment (this may take several minutes)</div>';

      try {
        const response = await fetchApi('/api/dashboard/enrich-batch', {
          method: 'POST',
          body: JSON.stringify({ lead_ids: leadIds, update_salesforce: updateSalesforce }),
        });

        const data = await response.json();

        resultDiv.innerHTML = `
          <div class="enrichment-result" style="margin-top: 20px;">
            <h4 style="color: ${data.successful > 0 ? '#10b981' : '#ef4444'};">Bulk Enrichment Complete</h4>
            <div class="stats-grid" style="margin: 15px 0;">
              <div class="stat-card"><h3>Processed</h3><div class="value">${data.processed}</div></div>
              <div class="stat-card"><h3>Successful</h3><div class="value green">${data.successful}</div></div>
              <div class="stat-card"><h3>Failed</h3><div class="value red">${data.failed}</div></div>
            </div>
            <table>
              <thead><tr><th>Lead ID</th><th>Status</th><th>Fit Score</th></tr></thead>
              <tbody>
                ${data.results.map(r => `
                  <tr>
                    <td><code>${r.id}</code></td>
                    <td>${r.success ? '<span class="badge success">Success</span>' : `<span class="badge error">Failed</span>`}</td>
                    <td>${r.fit_score ?? '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (error) {
        resultDiv.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Enrich All Leads';
      }
    }

    // Helper to get date range for unenriched leads
    function getUnenrichedDateRange() {
      const selection = document.getElementById('unenrichedDateRange').value;
      const now = new Date();
      let startDate, endDate;

      switch (selection) {
        case 'this_month':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          endDate = now;
          break;
        case 'last_month':
          startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
          endDate = new Date(now.getFullYear(), now.getMonth(), 0);
          break;
        case 'this_quarter':
          const quarter = Math.floor(now.getMonth() / 3);
          startDate = new Date(now.getFullYear(), quarter * 3, 1);
          endDate = now;
          break;
        case 'last_7_days':
          startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          endDate = now;
          break;
        case 'last_30_days':
          startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
          endDate = now;
          break;
        case 'last_90_days':
          startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
          endDate = now;
          break;
        case 'this_year':
          startDate = new Date(now.getFullYear(), 0, 1);
          endDate = now;
          break;
        default:
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          endDate = now;
      }

      return {
        startDate: startDate.toISOString().split('T')[0],
        endDate: endDate.toISOString().split('T')[0]
      };
    }

    // Unenriched Leads
    async function loadUnenrichedLeads(page = 1) {
      const content = document.getElementById('unenriched-content');
      content.innerHTML = '<div class="loading">Loading unenriched leads</div>';
      selectedLeads.clear();

      try {
        const dateRange = getUnenrichedDateRange();
        const offset = (page - 1) * unenrichedPagination.pageSize;
        const response = await fetchApi(`/api/dashboard/unenriched?limit=${unenrichedPagination.pageSize}&offset=${offset}&startDate=${dateRange.startDate}&endDate=${dateRange.endDate}`);
        const data = await response.json();

        // Update pagination state
        unenrichedPagination.currentPage = page;
        unenrichedPagination.totalCount = data.totalCount;
        unenrichedPagination.totalPages = Math.ceil(data.totalCount / unenrichedPagination.pageSize);

        renderUnenrichedLeads(data, dateRange);
      } catch (error) {
        content.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
      }
    }

    // Pagination navigation functions
    function goToUnenrichedPage(page) {
      if (page < 1 || page > unenrichedPagination.totalPages) return;
      loadUnenrichedLeads(page);
    }

    function goToPreviousPage() {
      goToUnenrichedPage(unenrichedPagination.currentPage - 1);
    }

    function goToNextPage() {
      goToUnenrichedPage(unenrichedPagination.currentPage + 1);
    }

    function renderUnenrichedLeads(data, dateRange) {
      const content = document.getElementById('unenriched-content');
      const dateRangeLabel = dateRange
        ? `${new Date(dateRange.startDate).toLocaleDateString()} - ${new Date(dateRange.endDate).toLocaleDateString()}`
        : 'This Month';

      const { currentPage, totalPages, totalCount, pageSize } = unenrichedPagination;
      const startItem = ((currentPage - 1) * pageSize) + 1;
      const endItem = Math.min(currentPage * pageSize, totalCount);

      // Generate page numbers for pagination
      let pageNumbers = [];
      if (totalPages <= 7) {
        pageNumbers = Array.from({ length: totalPages }, (_, i) => i + 1);
      } else {
        if (currentPage <= 4) {
          pageNumbers = [1, 2, 3, 4, 5, '...', totalPages];
        } else if (currentPage >= totalPages - 3) {
          pageNumbers = [1, '...', totalPages - 4, totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
        } else {
          pageNumbers = [1, '...', currentPage - 1, currentPage, currentPage + 1, '...', totalPages];
        }
      }

      content.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Unenriched Leads</h3>
            <div class="value orange">${totalCount.toLocaleString()}</div>
          </div>
          <div class="stat-card">
            <h3>Date Range</h3>
            <div class="value" style="font-size: 14px;">${dateRangeLabel}</div>
          </div>
          <div class="stat-card">
            <h3>Showing</h3>
            <div class="value" style="font-size: 14px;">${startItem.toLocaleString()} - ${endItem.toLocaleString()}</div>
          </div>
        </div>

        <div class="selection-bar">
          <div>
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
            <label for="selectAll" style="margin-left: 8px;">Select All on Page</label>
            <span id="selectedCount" style="margin-left: 15px; color: #6b7280;">0 selected</span>
          </div>
          <button class="success" onclick="enrichSelected()" id="batchEnrichBtn" disabled>
            Enrich Selected (max 10)
          </button>
        </div>

        <div class="card">
          <h3>Unenriched Leads <span style="font-weight: normal; font-size: 14px; color: #6b7280;">Page ${currentPage} of ${totalPages}</span></h3>
          <table>
            <thead>
              <tr>
                <th style="width: 40px;"></th>
                <th>Company</th>
                <th>Website</th>
                <th>Phone</th>
                <th>Location</th>
                <th>Source</th>
                <th>Created</th>
              </tr>
            </thead>
            <tbody>
              ${data.leads.map(lead => `
                <tr>
                  <td><input type="checkbox" class="lead-checkbox" data-id="${lead.id}" onchange="toggleLeadSelection('${lead.id}')"></td>
                  <td><strong>${lead.company || '-'}</strong></td>
                  <td>${lead.website ? `<a href="${lead.website}" target="_blank">${truncate(lead.website, 25)}</a>` : '-'}</td>
                  <td>${lead.phone || '-'}</td>
                  <td>${[lead.city, lead.state].filter(Boolean).join(', ') || '-'}</td>
                  <td>${lead.leadSource || '-'}</td>
                  <td>${new Date(lead.createdDate).toLocaleDateString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>

          ${totalPages > 1 ? `
          <div class="pagination" style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
            <button class="outline" onclick="goToPreviousPage()" ${currentPage === 1 ? 'disabled' : ''} style="padding: 8px 12px;">
              &laquo; Previous
            </button>
            ${pageNumbers.map(p => p === '...'
              ? '<span style="padding: 8px;">...</span>'
              : `<button class="${p === currentPage ? '' : 'outline'}" onclick="goToUnenrichedPage(${p})" style="padding: 8px 12px; min-width: 40px;">${p}</button>`
            ).join('')}
            <button class="outline" onclick="goToNextPage()" ${currentPage === totalPages ? 'disabled' : ''} style="padding: 8px 12px;">
              Next &raquo;
            </button>
          </div>
          ` : ''}
        </div>

        <div id="batchResults"></div>
      `;
    }

    function truncate(str, len) {
      if (!str) return '';
      return str.length > len ? str.substring(0, len) + '...' : str;
    }

    function toggleLeadSelection(id) {
      if (selectedLeads.has(id)) selectedLeads.delete(id);
      else selectedLeads.add(id);
      updateSelectionUI();
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAll').checked;
      document.querySelectorAll('.lead-checkbox').forEach(cb => {
        cb.checked = selectAll;
        if (selectAll) selectedLeads.add(cb.dataset.id);
        else selectedLeads.delete(cb.dataset.id);
      });
      updateSelectionUI();
    }

    function updateSelectionUI() {
      document.getElementById('selectedCount').textContent = `${selectedLeads.size} selected`;
      document.getElementById('batchEnrichBtn').disabled = selectedLeads.size === 0;
    }

    async function enrichSelected() {
      if (selectedLeads.size === 0) return;
      if (selectedLeads.size > 10) {
        alert('Please select a maximum of 10 leads at a time.');
        return;
      }

      const btn = document.getElementById('batchEnrichBtn');
      const resultsDiv = document.getElementById('batchResults');

      btn.disabled = true;
      btn.textContent = 'Enriching...';
      resultsDiv.innerHTML = '<div class="loading">Processing enrichment</div>';

      try {
        const response = await fetchApi('/api/dashboard/enrich-batch', {
          method: 'POST',
          body: JSON.stringify({ lead_ids: Array.from(selectedLeads) }),
        });

        const data = await response.json();

        resultsDiv.innerHTML = `
          <div class="card">
            <h3>Enrichment Results</h3>
            <div class="stats-grid" style="margin-bottom: 20px;">
              <div class="stat-card"><h3>Processed</h3><div class="value">${data.processed}</div></div>
              <div class="stat-card"><h3>Successful</h3><div class="value green">${data.successful}</div></div>
              <div class="stat-card"><h3>Failed</h3><div class="value red">${data.failed}</div></div>
            </div>
            <table>
              <thead><tr><th>Lead ID</th><th>Status</th><th>Fit Score</th></tr></thead>
              <tbody>
                ${data.results.map(r => `
                  <tr>
                    <td>${r.id}</td>
                    <td>${r.success ? '<span class="badge success">Success</span>' : `<span class="badge error">Failed</span>`}</td>
                    <td>${r.fit_score ?? '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;

        setTimeout(() => loadUnenrichedLeads(), 2000);
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Enrich Selected (max 10)';
      }
    }

    // Setup Tab
    async function loadSetup() {
      const content = document.getElementById('setup-content');
      content.innerHTML = '<div class="loading">Loading system status</div>';

      try {
        const [statusRes, dbStatsRes] = await Promise.all([
          fetchApi('/api/setup/status'),
          fetchApi('/api/setup/database-stats')
        ]);

        if (!statusRes.ok) {
          const errorData = await parseResponse(statusRes);
          throw new Error(errorData.error || `HTTP ${statusRes.status}: Failed to fetch status`);
        }

        const status = await parseResponse(statusRes);
        const dbStats = dbStatsRes.ok ? await parseResponse(dbStatsRes) : null;

        content.innerHTML = `
          <div class="config-grid">
            <div class="card">
              <h3>Service Connections</h3>
              <table>
                <tbody>
                  <tr>
                    <td><strong>PostgreSQL Database</strong></td>
                    <td>
                      <div class="status-indicator">
                        <span class="status-dot ${status.services.database.connected ? 'green' : 'red'}"></span>
                        ${status.services.database.connected ? 'Connected' : 'Disconnected'}
                      </div>
                      ${status.services.database.error ? `<div style="color: #ef4444; font-size: 12px;">${status.services.database.error}</div>` : ''}
                    </td>
                  </tr>
                  <tr>
                    <td><strong>Salesforce</strong></td>
                    <td>
                      <div class="status-indicator">
                        <span class="status-dot ${status.services.salesforce.connected ? 'green' : 'red'}"></span>
                        ${status.services.salesforce.connected ? 'Connected' : 'Disconnected'}
                      </div>
                      ${status.services.salesforce.error ? `<div style="color: #ef4444; font-size: 12px;">${status.services.salesforce.error}</div>` : ''}
                    </td>
                  </tr>
                  <tr>
                    <td><strong>Google Places API</strong></td>
                    <td>
                      <div class="status-indicator">
                        <span class="status-dot ${status.services.googlePlaces.configured ? 'green' : 'yellow'}"></span>
                        ${status.services.googlePlaces.configured ? 'Configured' : 'Not Configured'}
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td><strong>Clay API</strong></td>
                    <td>
                      <div class="status-indicator">
                        <span class="status-dot ${status.services.clay.configured ? 'green' : 'yellow'}"></span>
                        ${status.services.clay.configured ? 'Configured' : 'Not Configured'}
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="card">
              <h3>Environment Configuration</h3>
              <table>
                <tbody>
                  ${Object.entries(status.environment).map(([key, value]) => `
                    <tr>
                      <td><code style="font-size: 12px;">${key}</code></td>
                      <td><span class="badge ${value === 'NOT SET' ? 'warning' : 'info'}">${value}</span></td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>

          ${dbStats ? `
          <div class="card" style="margin-top: 20px;">
            <h3>Database Statistics</h3>
            <div class="stats-grid">
              <div class="stat-card"><h3>Total Records</h3><div class="value">${parseInt(dbStats.stats.total_enrichments).toLocaleString()}</div></div>
              <div class="stat-card"><h3>Completed</h3><div class="value green">${parseInt(dbStats.stats.completed || 0).toLocaleString()}</div></div>
              <div class="stat-card"><h3>Failed</h3><div class="value red">${parseInt(dbStats.stats.failed || 0).toLocaleString()}</div></div>
              <div class="stat-card"><h3>Avg Fit Score</h3><div class="value purple">${dbStats.stats.avg_fit_score ?? '-'}</div></div>
            </div>
            ${dbStats.scoreDistribution && dbStats.scoreDistribution.length > 0 ? `
            <h4 style="margin: 20px 0 10px;">Score Distribution (Local DB)</h4>
            <table>
              <thead><tr><th>Score Range</th><th>Count</th></tr></thead>
              <tbody>
                ${dbStats.scoreDistribution.map(s => `
                  <tr>
                    <td><span class="badge info">${s.score_range}</span></td>
                    <td>${parseInt(s.count).toLocaleString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            ` : ''}
          </div>
          ` : ''}

          <div class="card" style="margin-top: 20px;">
            <h3>Server Info</h3>
            <table>
              <tbody>
                <tr><td><strong>Server Time</strong></td><td>${new Date(status.serverTime).toLocaleString()}</td></tr>
                <tr><td><strong>Uptime</strong></td><td>${formatUptime(status.uptime)}</td></tr>
              </tbody>
            </table>
          </div>
        `;

        // Load saved Workato webhook URL
        const savedWebhookUrl = localStorage.getItem('tsi_workato_webhook_url') || '';
        document.getElementById('workatoWebhookUrl').value = savedWebhookUrl;
      } catch (error) {
        content.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
      }
    }

    function formatUptime(seconds) {
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const parts = [];
      if (days > 0) parts.push(`${days}d`);
      if (hours > 0) parts.push(`${hours}h`);
      parts.push(`${minutes}m`);
      return parts.join(' ');
    }

    async function loadLogs() {
      const content = document.getElementById('logs-content');
      const level = document.getElementById('logLevel').value;

      content.innerHTML = '<div class="loading">Loading logs</div>';

      try {
        const response = await fetchApi(`/api/setup/logs?limit=100${level ? `&level=${level}` : ''}`);

        if (!response.ok) {
          const errorData = await parseResponse(response);
          throw new Error(errorData.error || `HTTP ${response.status}`);
        }

        const data = await parseResponse(response);

        if (!data.logs || data.logs.length === 0) {
          content.innerHTML = '<div style="padding: 40px; text-align: center; color: #6b7280;">No logs found. Logs will appear here as the server processes requests.</div>';
          return;
        }

        content.innerHTML = data.logs.map(log => `
          <div class="log-entry">
            <span class="timestamp">${new Date(log.timestamp).toLocaleTimeString()}</span>
            <span class="level ${log.level}">${log.level.toUpperCase()}</span>
            <span class="message">${escapeHtml(log.message)}${log.meta ? ` <code style="color: #6b7280;">${escapeHtml(JSON.stringify(log.meta))}</code>` : ''}</span>
          </div>
        `).join('');
      } catch (error) {
        console.error('Logs load error:', error);
        content.innerHTML = `<div class="error-message">Error loading logs: ${escapeHtml(error.message)}</div>`;
      }
    }

    // Workato webhook functions
    function saveWorkatoWebhook() {
      const url = document.getElementById('workatoWebhookUrl').value.trim();
      if (url) {
        localStorage.setItem('tsi_workato_webhook_url', url);
        const resultDiv = document.getElementById('webhookTestResult');
        resultDiv.innerHTML = '<div class="badge success" style="margin-top: 10px;">Webhook URL saved</div>';
        setTimeout(() => { resultDiv.innerHTML = ''; }, 3000);
      }
    }

    async function testWorkatoWebhook() {
      const url = document.getElementById('workatoWebhookUrl').value.trim();
      const resultDiv = document.getElementById('webhookTestResult');

      if (!url) {
        resultDiv.innerHTML = '<div class="badge warning" style="margin-top: 10px;">Please enter a webhook URL first</div>';
        return;
      }

      resultDiv.innerHTML = '<div class="loading" style="margin-top: 10px;">Testing webhook...</div>';

      try {
        // Send a test payload to the webhook
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          mode: 'no-cors', // Workato webhooks may not return CORS headers
          body: JSON.stringify({
            test: true,
            message: 'TSI Fit Score webhook test',
            timestamp: new Date().toISOString()
          })
        });

        // With no-cors mode, we can't read the response, but if no error was thrown, the request was sent
        resultDiv.innerHTML = '<div class="badge success" style="margin-top: 10px;">Test request sent (check Workato job history)</div>';
        localStorage.setItem('tsi_workato_webhook_url', url);
      } catch (error) {
        resultDiv.innerHTML = `<div class="badge error" style="margin-top: 10px;">Failed to send test: ${error.message}</div>`;
      }
    }
  </script>
</body>
</html>
