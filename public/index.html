<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TSI Fit Score Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f7fa;
      color: #333;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }
    h1 {
      font-size: 28px;
      color: #1a1a2e;
    }
    .controls {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    select, button, input {
      padding: 10px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }
    button {
      background: #4f46e5;
      color: white;
      border: none;
    }
    button:hover {
      background: #4338ca;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    button.secondary {
      background: #6b7280;
    }
    button.secondary:hover {
      background: #4b5563;
    }
    button.success {
      background: #10b981;
    }
    button.success:hover {
      background: #059669;
    }
    .last-updated {
      color: #666;
      font-size: 13px;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 10px;
    }
    .tab {
      padding: 10px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #6b7280;
      border-radius: 8px 8px 0 0;
    }
    .tab.active {
      color: #4f46e5;
      font-weight: 600;
      background: #eef2ff;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .stat-card h3 {
      font-size: 13px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #1a1a2e;
    }
    .stat-card .value.green { color: #10b981; }
    .stat-card .value.blue { color: #3b82f6; }
    .stat-card .value.purple { color: #8b5cf6; }
    .stat-card .value.orange { color: #f97316; }
    .charts-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    .chart-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .chart-card h2 {
      font-size: 18px;
      margin-bottom: 20px;
      color: #1a1a2e;
    }
    .chart-container {
      position: relative;
      height: 300px;
    }
    .table-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .table-card h2 {
      font-size: 18px;
      margin-bottom: 20px;
      color: #1a1a2e;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #666;
      font-weight: 600;
    }
    td {
      font-size: 14px;
    }
    .progress-bar {
      width: 100px;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }
    .progress-bar .fill {
      height: 100%;
      background: #10b981;
      border-radius: 4px;
    }
    .loading {
      text-align: center;
      padding: 60px;
      color: #666;
    }
    .error {
      text-align: center;
      padding: 60px;
      color: #ef4444;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge.disqualified { background: #fee2e2; color: #dc2626; }
    .badge.mql { background: #fef3c7; color: #d97706; }
    .badge.high-fit { background: #d1fae5; color: #059669; }
    .badge.premium { background: #dbeafe; color: #2563eb; }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .selection-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #eef2ff;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .api-key-input {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #fff7ed;
      border-radius: 8px;
      border: 1px solid #fed7aa;
    }
    .api-key-input input {
      flex: 1;
      max-width: 400px;
    }
    .api-key-input label {
      font-weight: 600;
      color: #9a3412;
    }
    @media (max-width: 768px) {
      .charts-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>TSI Fit Score Dashboard</h1>
      <div class="controls">
        <select id="daysSelect">
          <option value="7">Last 7 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="60">Last 60 days</option>
          <option value="90">Last 90 days</option>
        </select>
        <button onclick="loadData()">Refresh</button>
        <span class="last-updated" id="lastUpdated"></span>
      </div>
    </header>

    <div class="api-key-input">
      <label for="apiKey">API Key:</label>
      <input type="password" id="apiKey" placeholder="Enter your API key" onchange="saveApiKey()">
      <button class="secondary" onclick="toggleApiKey()">Show</button>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('overview')">Overview</button>
      <button class="tab" onclick="switchTab('unenriched')">Unenriched Leads</button>
    </div>

    <div id="overview-tab" class="tab-content active">
      <div id="overview-content">
        <div class="loading">Loading dashboard data...</div>
      </div>
    </div>

    <div id="unenriched-tab" class="tab-content">
      <div id="unenriched-content">
        <div class="loading">Loading unenriched leads...</div>
      </div>
    </div>
  </div>

  <script>
    let tierChart, sourceChart;
    let selectedLeads = new Set();

    // API Key management
    function getApiKey() {
      return document.getElementById('apiKey').value || localStorage.getItem('tsi_api_key') || '';
    }

    function saveApiKey() {
      const key = document.getElementById('apiKey').value;
      if (key) {
        localStorage.setItem('tsi_api_key', key);
      }
    }

    function toggleApiKey() {
      const input = document.getElementById('apiKey');
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    // Load saved API key on page load
    document.addEventListener('DOMContentLoaded', () => {
      const savedKey = localStorage.getItem('tsi_api_key');
      if (savedKey) {
        document.getElementById('apiKey').value = savedKey;
      }
    });

    // Tab switching
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
      document.getElementById(`${tab}-tab`).classList.add('active');

      if (tab === 'unenriched') {
        loadUnenrichedLeads();
      }
    }

    // Fetch with API key
    async function fetchWithAuth(url, options = {}) {
      const apiKey = getApiKey();
      if (!apiKey) {
        throw new Error('API key is required. Please enter your API key above.');
      }

      return fetch(url, {
        ...options,
        headers: {
          'X-API-Key': apiKey,
          'Content-Type': 'application/json',
          ...(options.headers || {}),
        },
      });
    }

    async function loadData() {
      const days = document.getElementById('daysSelect').value;
      const content = document.getElementById('overview-content');

      content.innerHTML = '<div class="loading">Loading dashboard data...</div>';

      try {
        const response = await fetchWithAuth(`/api/dashboard/stats?days=${days}`);
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to fetch data');
        }

        const data = await response.json();
        renderDashboard(data);
      } catch (error) {
        content.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }

    function renderDashboard(data) {
      const content = document.getElementById('overview-content');

      document.getElementById('lastUpdated').textContent =
        `Updated: ${new Date(data.lastUpdated).toLocaleString()}`;

      content.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Total Leads</h3>
            <div class="value">${data.totalLeads.toLocaleString()}</div>
          </div>
          <div class="stat-card">
            <h3>Enriched</h3>
            <div class="value blue">${data.enrichedLeads.toLocaleString()}</div>
          </div>
          <div class="stat-card">
            <h3>Unenriched</h3>
            <div class="value orange">${data.unenrichedLeads.toLocaleString()}</div>
          </div>
          <div class="stat-card">
            <h3>Enrichment Rate</h3>
            <div class="value green">${data.enrichmentRate.toFixed(1)}%</div>
          </div>
          <div class="stat-card">
            <h3>Avg Fit Score</h3>
            <div class="value purple">${data.avgFitScore.toFixed(1)}</div>
          </div>
        </div>

        <div class="charts-row">
          <div class="chart-card">
            <h2>Fit Tier Distribution</h2>
            <div class="chart-container">
              <canvas id="tierChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h2>Leads by Source</h2>
            <div class="chart-container">
              <canvas id="sourceChart"></canvas>
            </div>
          </div>
        </div>

        <div class="table-card">
          <h2>Lead Source Breakdown</h2>
          <table>
            <thead>
              <tr>
                <th>Lead Source</th>
                <th>Total Leads</th>
                <th>Enriched</th>
                <th>Enrichment Rate</th>
                <th>Avg Fit Score</th>
                <th>Tier Distribution</th>
              </tr>
            </thead>
            <tbody>
              ${data.byLeadSource.map(source => `
                <tr>
                  <td><strong>${source.leadSource}</strong></td>
                  <td>${source.totalLeads.toLocaleString()}</td>
                  <td>${source.enrichedLeads.toLocaleString()}</td>
                  <td>
                    <div class="progress-bar">
                      <div class="fill" style="width: ${source.enrichmentRate}%"></div>
                    </div>
                    ${source.enrichmentRate.toFixed(1)}%
                  </td>
                  <td>${source.avgFitScore.toFixed(1)}</td>
                  <td>${source.tierDistribution.map(t => `${t.tier}: ${t.count}`).join(' | ')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      renderTierChart(data.tierDistribution);
      renderSourceChart(data.byLeadSource);
    }

    function renderTierChart(distribution) {
      const ctx = document.getElementById('tierChart').getContext('2d');

      if (tierChart) tierChart.destroy();

      const colors = {
        'Disqualified': '#ef4444',
        'MQL': '#f97316',
        'High Fit': '#22c55e',
        'Premium': '#3b82f6',
      };

      tierChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: distribution.map(d => d.tier),
          datasets: [{
            label: 'Number of Leads',
            data: distribution.map(d => d.count),
            backgroundColor: distribution.map(d => colors[d.tier] || '#6b7280'),
            borderRadius: 6,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#f0f0f0' }
            },
            x: {
              grid: { display: false }
            }
          }
        }
      });
    }

    function renderSourceChart(sources) {
      const ctx = document.getElementById('sourceChart').getContext('2d');

      if (sourceChart) sourceChart.destroy();

      const topSources = sources.slice(0, 8);

      const colors = [
        '#4f46e5', '#7c3aed', '#ec4899', '#f43f5e',
        '#f97316', '#eab308', '#22c55e', '#06b6d4'
      ];

      sourceChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: topSources.map(s => s.leadSource),
          datasets: [{
            data: topSources.map(s => s.totalLeads),
            backgroundColor: colors,
            borderWidth: 0,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                padding: 15,
                usePointStyle: true,
              }
            }
          }
        }
      });
    }

    // Unenriched leads tab
    async function loadUnenrichedLeads() {
      const content = document.getElementById('unenriched-content');
      content.innerHTML = '<div class="loading">Loading unenriched leads...</div>';
      selectedLeads.clear();

      try {
        const response = await fetchWithAuth('/api/dashboard/unenriched?limit=100');
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to fetch unenriched leads');
        }

        const data = await response.json();
        renderUnenrichedLeads(data);
      } catch (error) {
        content.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }

    function renderUnenrichedLeads(data) {
      const content = document.getElementById('unenriched-content');

      content.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Total Unenriched Leads</h3>
            <div class="value orange">${data.totalCount.toLocaleString()}</div>
          </div>
          <div class="stat-card">
            <h3>Showing</h3>
            <div class="value">${data.leads.length}</div>
          </div>
        </div>

        <div class="selection-bar">
          <div>
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
            <label for="selectAll">Select All</label>
            <span id="selectedCount" style="margin-left: 15px; color: #6b7280;">0 selected</span>
          </div>
          <button class="success" onclick="enrichSelected()" id="enrichBtn" disabled>
            Enrich Selected Leads
          </button>
        </div>

        <div class="table-card">
          <h2>Unenriched Leads (Most Recent)</h2>
          <table>
            <thead>
              <tr>
                <th style="width: 40px;"></th>
                <th>Company</th>
                <th>Website</th>
                <th>Phone</th>
                <th>Location</th>
                <th>Lead Source</th>
                <th>Created</th>
              </tr>
            </thead>
            <tbody>
              ${data.leads.map(lead => `
                <tr>
                  <td>
                    <input type="checkbox" class="lead-checkbox" data-id="${lead.id}"
                           onchange="toggleLeadSelection('${lead.id}')">
                  </td>
                  <td><strong>${lead.company || '-'}</strong></td>
                  <td>${lead.website ? `<a href="${lead.website}" target="_blank">${truncate(lead.website, 30)}</a>` : '-'}</td>
                  <td>${lead.phone || '-'}</td>
                  <td>${[lead.city, lead.state].filter(Boolean).join(', ') || '-'}</td>
                  <td>${lead.leadSource || '-'}</td>
                  <td>${new Date(lead.createdDate).toLocaleDateString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div id="enrichmentResults"></div>
      `;
    }

    function truncate(str, len) {
      if (!str) return '';
      return str.length > len ? str.substring(0, len) + '...' : str;
    }

    function toggleLeadSelection(id) {
      if (selectedLeads.has(id)) {
        selectedLeads.delete(id);
      } else {
        selectedLeads.add(id);
      }
      updateSelectionUI();
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAll').checked;
      const checkboxes = document.querySelectorAll('.lead-checkbox');

      checkboxes.forEach(cb => {
        cb.checked = selectAll;
        const id = cb.dataset.id;
        if (selectAll) {
          selectedLeads.add(id);
        } else {
          selectedLeads.delete(id);
        }
      });

      updateSelectionUI();
    }

    function updateSelectionUI() {
      document.getElementById('selectedCount').textContent = `${selectedLeads.size} selected`;
      document.getElementById('enrichBtn').disabled = selectedLeads.size === 0;
    }

    async function enrichSelected() {
      if (selectedLeads.size === 0) return;
      if (selectedLeads.size > 10) {
        alert('Please select a maximum of 10 leads at a time.');
        return;
      }

      const btn = document.getElementById('enrichBtn');
      btn.disabled = true;
      btn.textContent = 'Enriching...';

      const resultsDiv = document.getElementById('enrichmentResults');
      resultsDiv.innerHTML = '<div class="loading">Processing enrichment...</div>';

      try {
        const response = await fetchWithAuth('/api/dashboard/enrich-batch', {
          method: 'POST',
          body: JSON.stringify({ lead_ids: Array.from(selectedLeads) }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Enrichment failed');
        }

        const data = await response.json();

        resultsDiv.innerHTML = `
          <div class="table-card">
            <h2>Enrichment Results</h2>
            <div class="stats-grid" style="margin-bottom: 20px;">
              <div class="stat-card">
                <h3>Processed</h3>
                <div class="value">${data.processed}</div>
              </div>
              <div class="stat-card">
                <h3>Successful</h3>
                <div class="value green">${data.successful}</div>
              </div>
              <div class="stat-card">
                <h3>Failed</h3>
                <div class="value" style="color: #ef4444;">${data.failed}</div>
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Lead ID</th>
                  <th>Status</th>
                  <th>Fit Score</th>
                  <th>Fit Tier</th>
                </tr>
              </thead>
              <tbody>
                ${data.results.map(r => `
                  <tr>
                    <td>${r.id}</td>
                    <td>${r.success ? '<span style="color: #10b981;">Success</span>' : `<span style="color: #ef4444;">Failed: ${r.error}</span>`}</td>
                    <td>${r.fit_score ?? '-'}</td>
                    <td>${r.fit_tier ? `<span class="badge ${r.fit_tier.toLowerCase().replace(' ', '-')}">${r.fit_tier}</span>` : '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;

        // Refresh the list
        setTimeout(() => loadUnenrichedLeads(), 2000);
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Enrich Selected Leads';
      }
    }

    // Load data on page load
    loadData();

    // Auto-refresh every 5 minutes
    setInterval(loadData, 5 * 60 * 1000);
  </script>
</body>
</html>
