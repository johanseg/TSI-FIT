---
phase: 01-security-hardening
plan: 01
type: execute
---

<objective>
Fix SOQL injection vulnerabilities across batch enrichment, Workato endpoints, and dashboard statistics.

Purpose: Eliminate critical security vulnerability (CWE-89) where user-controlled input is directly interpolated into SOQL queries, preventing potential data exposure and unauthorized database access.

Output: All 4 vulnerable locations patched with Salesforce ID format validation, preventing SOQL injection attacks.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@src/index.ts
@src/services/dashboardStats.ts
@src/services/salesforce.ts

**Vulnerability locations (from CONCERNS.md):**
- `src/index.ts:1128` - Batch GMB enrichment
- `src/index.ts:1600` - Workato automatic enrichment
- `src/services/dashboardStats.ts:233` - Lead source filter
- `src/services/salesforce.ts:188` - Lead verification

**Existing patterns:**
- `authenticateApiKey` middleware already exists in `src/index.ts:91-107`
- Salesforce ID format: `00[a-zA-Z0-9]{13}` (15 characters starting with "00")
- Error handling pattern: Return 400 with descriptive error message

**Constraining decisions:**
- Must maintain API compatibility (Workato integration)
- No breaking changes to request/response contracts
- Keep monolithic architecture (no refactoring)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Salesforce ID validation utility function</name>
  <files>src/utils/validation.ts</files>
  <action>Create new file with `validateSalesforceId(id: string): boolean` function that validates Salesforce Lead ID format using regex `^00[a-zA-Z0-9]{13}$`. Also create `validateSalesforceIds(ids: string[]): { valid: boolean; invalidIds: string[] }` for batch validation. Export both functions. Keep it simple - pure validation, no logging (callers will log).</action>
  <verify>Create test: `validateSalesforceId('00Q1234567890AB')` returns true, `validateSalesforceId('invalid')` returns false, `validateSalesforceIds(['00Q...', 'bad'])` returns `{valid: false, invalidIds: ['bad']}`</verify>
  <done>Validation functions exist, correctly identify valid/invalid Salesforce IDs, exported for use</done>
</task>

<task type="auto">
  <name>Task 2: Fix SOQL injection in batch GMB enrichment endpoint</name>
  <files>src/index.ts</files>
  <action>In batch GMB enrichment endpoint (line ~1128), before building query string: call `validateSalesforceIds(lead_ids)` from `src/utils/validation.ts`. If validation fails, return 400 with error: `{"error": "Invalid Salesforce Lead IDs", "invalidIds": [...]}`. Only build query if all IDs valid. This prevents injection by ensuring only valid ID format reaches query string. Do NOT use parameterized queries (jsforce doesn't support them for SOQL).</action>
  <verify>Manual test: POST request with invalid ID returns 400 before query execution, valid IDs proceed normally</verify>
  <done>Batch endpoint validates all Lead IDs before query construction, rejects invalid formats with 400</done>
</task>

<task type="auto">
  <name>Task 3: Fix SOQL injection in Workato automatic enrichment and dashboardStats</name>
  <files>src/index.ts, src/services/dashboardStats.ts, src/services/salesforce.ts</files>
  <action>Apply same validation pattern to 3 remaining locations: (1) Workato endpoint `src/index.ts:~1600` - validate `salesforce_lead_id` before query; (2) `dashboardStats.ts:~233` - validate `leadSource` if it's used in Lead ID context, otherwise sanitize by allowing only alphanumeric + common chars; (3) `salesforce.ts:~188` - validate `leadId` parameter. Each location: validate, return/throw error if invalid, only proceed if valid. Import `validateSalesforceId` where needed.</action>
  <verify>Check all 4 locations: grep shows no direct string interpolation without validation preceding it</verify>
  <done>All 4 SOQL injection vulnerabilities patched with input validation, preventing malicious input from reaching queries</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `src/utils/validation.ts` exists with Salesforce ID validation functions
- [ ] All 4 vulnerable locations identified in CONCERNS.md now validate input before query construction
- [ ] No TypeScript errors: `npm run build` succeeds
- [ ] Manual verification: Invalid Salesforce IDs rejected with 400 error before query execution
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- SOQL injection attack surface eliminated
- API contracts unchanged (backwards compatible)
- No new dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-hardening/01-01-SUMMARY.md`:

# Phase 1 Plan 1: Fix SOQL Injection Vulnerabilities Summary

**Eliminated SOQL injection vulnerabilities across 4 endpoints via input validation**

## Accomplishments

- Created Salesforce ID validation utility (`src/utils/validation.ts`)
- Patched batch GMB enrichment endpoint (src/index.ts:1128)
- Patched Workato automatic enrichment (src/index.ts:1600)
- Patched dashboardStats lead source filter (src/services/dashboardStats.ts:233)
- Patched Salesforce lead verification (src/services/salesforce.ts:188)

## Files Created/Modified

- `src/utils/validation.ts` - Salesforce ID validation functions
- `src/index.ts` - Added validation to 2 endpoints
- `src/services/dashboardStats.ts` - Added input sanitization
- `src/services/salesforce.ts` - Added ID validation

## Decisions Made

- Used format validation (regex) instead of parameterized queries (jsforce doesn't support them for SOQL)
- Created reusable validation utility for consistency across codebase
- Maintained existing error response format (400 with descriptive message)

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 01-02-PLAN.md (Add authentication to admin endpoints)
</output>
