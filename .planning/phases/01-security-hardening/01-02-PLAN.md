---
phase: 01-security-hardening
plan: 02
type: execute
---

<objective>
Secure admin endpoints with authentication middleware and validate required environment variables at startup.

Purpose: Prevent unauthorized access to sensitive diagnostic endpoints and ensure application fails fast with clear error messages when misconfigured, rather than failing at runtime.

Output: Admin endpoints protected by API key authentication, startup validation preventing server launch with missing critical env vars.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/phases/01-security-hardening/01-01-SUMMARY.md
@src/index.ts

**Vulnerable admin endpoints (from CONCERNS.md):**
- `GET /api/setup/status` - Exposes environment variable status
- `GET /api/setup/logs` - Exposes 500 recent log entries
- `POST /api/setup/test-database` - Runs database queries
- `GET /api/setup/database-stats` - Exposes database statistics

**Existing patterns:**
- `authenticateApiKey` middleware exists at `src/index.ts:91-107`
- Middleware already used on production endpoints: `/enrich`, `/api/workato/enrich`, `/enrichment/:id`
- Current route pattern: `app.get('/api/setup/status', async (req, res) => {...})`

**Required environment variables (from CLAUDE.md + .env.example):**
- `DATABASE_URL` - PostgreSQL connection
- `GOOGLE_PLACES_API_KEY` - Google Places API
- `PDL_API_KEY` - People Data Labs API
- `API_KEY` - Workato webhook authentication
- `SFDC_CLIENT_ID`, `SFDC_CLIENT_SECRET`, `SFDC_USERNAME`, `SFDC_PASSWORD`, `SFDC_SECURITY_TOKEN`, `SFDC_LOGIN_URL` - Salesforce OAuth

**Constraining decisions:**
- Keep monolithic architecture (no route extraction)
- Maintain existing error response patterns
- Fail fast on startup, not runtime
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add authentication middleware to all admin endpoints</name>
  <files>src/index.ts</files>
  <action>Find all 4 admin endpoint definitions (`/api/setup/status`, `/api/setup/logs`, `/api/setup/test-database`, `/api/setup/database-stats`) around lines 138-293. Add `authenticateApiKey` middleware as second parameter to each route handler. Pattern: `app.get('/api/setup/status', authenticateApiKey, async (req, res) => {...})`. This is identical to how `/enrich` and `/api/workato/enrich` are protected. No new code needed - just apply existing middleware.</action>
  <verify>Grep shows all 4 endpoints now have `authenticateApiKey` middleware. Manual test: GET /api/setup/status without X-API-Key header returns 401</verify>
  <done>All admin endpoints require valid API key, return 401 if missing/invalid, 200 with data if valid</done>
</task>

<task type="auto">
  <name>Task 2: Create environment variable validation at startup</name>
  <files>src/index.ts</files>
  <action>After imports section (around line 50-60), before any service initialization, add validation function: `validateRequiredEnvVars()`. Check existence of: DATABASE_URL, GOOGLE_PLACES_API_KEY, PDL_API_KEY, API_KEY, SFDC_CLIENT_ID, SFDC_CLIENT_SECRET, SFDC_USERNAME, SFDC_PASSWORD, SFDC_SECURITY_TOKEN, SFDC_LOGIN_URL. If any missing, log error with list of missing vars and `process.exit(1)`. Call this function immediately before `pool.connect()` check (currently at line ~122). This ensures server never starts with missing config.</action>
  <verify>Test: Comment out DATABASE_URL in .env, run `npm run dev`, server exits immediately with clear error listing missing var(s)</verify>
  <done>Server validates all required env vars at startup, exits with clear error message if any missing, preventing runtime failures</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] All 4 admin endpoints (`/api/setup/*`) have `authenticateApiKey` middleware
- [ ] Startup validation function exists and runs before server starts
- [ ] Manual test: Admin endpoints return 401 without valid API key
- [ ] Manual test: Server exits immediately if required env var missing
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] Phase 1 complete: All SOQL injection vulnerabilities fixed (from 01-01), all admin endpoints secured, startup validation added
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Admin endpoints inaccessible without authentication
- Server fails fast with clear error on misconfiguration
- No breaking changes to existing authenticated endpoints
- Phase 1 (Security Hardening) complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-hardening/01-02-SUMMARY.md`:

# Phase 1 Plan 2: Secure Admin Endpoints & Startup Validation Summary

**Protected diagnostic endpoints with authentication and added fail-fast startup validation**

## Accomplishments

- Added `authenticateApiKey` middleware to 4 admin endpoints
- Created startup environment variable validation
- Server now fails immediately with clear error if misconfigured
- All diagnostic/setup endpoints require valid API key

## Files Created/Modified

- `src/index.ts` - Added middleware to admin routes, added startup validation function

## Decisions Made

- Reused existing `authenticateApiKey` middleware (no new auth mechanism needed)
- Startup validation runs before any service initialization to fail fast
- Validated 11 required environment variables (DB, APIs, Salesforce OAuth)

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 1 (Security Hardening) complete. All security vulnerabilities addressed:
- ✅ SOQL injection vulnerabilities fixed (4 locations)
- ✅ Admin endpoints secured with authentication
- ✅ Startup validation prevents misconfiguration

Ready for Phase 2: UX Improvements
</output>
