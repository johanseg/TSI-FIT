---
phase: 03-manual-enrichment-enhancement
plan: 03-01
type: execute
---

<objective>
Enhance manual enrichment lookup results to show all updatable Salesforce fields with visual change highlighting, enabling users to preview what will change before enriching.

Purpose: Improve manual enrichment workflow transparency by showing which fields will be updated and highlighting changes from current to new values.
Output: Lookup results displaying all 9 Salesforce enrichment fields with change indicators when values differ from current state
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/STRUCTURE.md
@.planning/phases/02-ux-improvements/02-01-SUMMARY.md
@.planning/phases/02-ux-improvements/02-02-SUMMARY.md
@.planning/phases/02-ux-improvements/02-03-SUMMARY.md
@public/index.html
@src/services/salesforceFieldMapper.ts

**Established patterns:**
- Dashboard UI in static HTML with inline JavaScript (Phase 2)
- Grid layout for data display: `.result-grid` with `.result-item` children (lines 1642-1650)
- Badge styling: `.badge.success`, `.badge.warning`, `.badge.error` (lines 1714, 1729)
- Client-side data transformation and display (all Phase 2 work)

**Current state:**
- lookupLead() function (lines 1617-1672) shows only 7 basic fields
- enrichLead() function (lines 1674-1843) shows full enrichment results AFTER enrichment completes
- No preview of what will change before enriching

**Available Salesforce enrichment fields (from salesforceFieldMapper.ts):**
1. Has_Website__c - Boolean
2. Number_of_Employees__c - Picklist (0, 1-2, 3-5, Over 5)
3. Number_of_GBP_Reviews__c - Picklist (Under 15, Over 14)
4. Number_of_Years_in_Business__c - Picklist (Under 1 Year, 1-3 Years, 3-5 Years, 5-10+ years)
5. Has_GMB__c - Boolean
6. GMB_URL__c - URL
7. Location_Type__c - Picklist (Home Office, Physical Location (Office), Retail Location (Store Front))
8. Business_License__c - Boolean (not determinable, always null)
9. Spending_on_Marketing__c - Boolean

**Constraining decisions:**
- Phase 1: Preserve monolithic architecture (no refactoring, incremental improvements only)
- Phase 2: Established result-grid pattern for dashboard data display
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fetch and compute new Salesforce field values in lookupLead()</name>
  <files>public/index.html</files>
  <action>
Modify lookupLead() function (line 1617) to:

1. After fetching lead data from `/api/lead/${leadId}`, make additional call to simulate what enrichment would produce:
   - Call `POST /api/enrich-by-id` with `{salesforce_lead_id: leadId, update_salesforce: false}` to get enrichment preview
   - This returns the same enrichment data structure as real enrichment but doesn't update Salesforce

2. If enrichment preview succeeds, compute new Salesforce field values using the same logic as salesforceFieldMapper:
   - Extract google_places, pdl, website_tech from enrichment data
   - Map to Salesforce fields:
     - has_website: !! (website_tech || data.salesforce.Website || google_places?.gmb_website)
     - number_of_employees: Map pdl?.employee_count (0→"0", 1-2→"1 - 2", 3-5→"3 - 5", 6+→"Over 5", null→null)
     - number_of_gbp_reviews: Map google_places?.gmb_review_count (<15→"Under 15", ≥15→"Over 14", null→null)
     - number_of_years_in_business: Map pdl?.years_in_business (<1→"Under 1 Year", 1-3→"1 - 3 Years", 3-5→"3 - 5 Years", ≥5→"5 - 10+ years", null→null)
     - has_gmb: !! google_places?.place_id
     - gmb_url: place_id ? `https://www.google.com/maps/place/?q=place_id:${place_id}` : null
     - location_type: Determine from google_places (see salesforceFieldMapper.ts mapLocationType logic)
     - business_license: null (always - not determinable)
     - spending_on_marketing: (pdl?.years_in_business > 2 && website_tech?.pixel_count > 0) || false

3. Store computed field values in a `newSalesforceFields` object for rendering

Do NOT modify the renderinging yet - just add the enrichment preview fetch and field computation logic. Handle errors gracefully (if preview fails, show current data without change indicators).
  </action>
  <verify>
Grep for "enrich-by-id.*update_salesforce.*false": `grep -n "update_salesforce.*false" public/index.html`
Should show the preview call in lookupLead function.
  </verify>
  <done>lookupLead() fetches enrichment preview and computes new Salesforce field values, stores in newSalesforceFields object</done>
</task>

<task type="auto">
  <name>Task 2: Add Salesforce enrichment fields section with change highlighting to lookup results</name>
  <files>public/index.html</files>
  <action>
In lookupLead() function, after the "Salesforce Lead Data" section (line 1651) and before "Last Local Enrichment" section (line 1655), add new "Fields That Will Be Updated" section:

```javascript
// After Salesforce Lead Data section closes (line 1651)
if (newSalesforceFields) {
  html += `
    <div class="result-section">
      <h5>Fields That Will Be Updated (Preview)</h5>
      <div class="result-grid">
        ${renderFieldWithChange('Has Website', data.salesforce.Has_Website__c, newSalesforceFields.has_website, 'boolean')}
        ${renderFieldWithChange('Number of Employees', data.salesforce.Number_of_Employees__c, newSalesforceFields.number_of_employees, 'text')}
        ${renderFieldWithChange('GBP Reviews', data.salesforce.Number_of_GBP_Reviews__c, newSalesforceFields.number_of_gbp_reviews, 'text')}
        ${renderFieldWithChange('Years in Business', data.salesforce.Number_of_Years_in_Business__c, newSalesforceFields.number_of_years_in_business, 'text')}
        ${renderFieldWithChange('Has GMB', data.salesforce.Has_GMB__c, newSalesforceFields.has_gmb, 'boolean')}
        ${renderFieldWithChange('GMB URL', data.salesforce.GMB_URL__c, newSalesforceFields.gmb_url, 'url')}
        ${renderFieldWithChange('Location Type', data.salesforce.Location_Type__c, newSalesforceFields.location_type, 'text')}
        ${renderFieldWithChange('Business License', data.salesforce.Business_License__c, newSalesforceFields.business_license, 'boolean')}
        ${renderFieldWithChange('Spending on Marketing', data.salesforce.Spending_on_Marketing__c, newSalesforceFields.spending_on_marketing, 'boolean')}
      </div>
    </div>
  `;
}
```

Then add helper function renderFieldWithChange() right before lookupLead() function (around line 1615):

```javascript
function renderFieldWithChange(label, currentValue, newValue, type) {
  // Normalize null/undefined to '-' for display
  const current = currentValue ?? '-';
  const newVal = newValue ?? '-';

  // Determine if there's a change
  const hasChange = current !== newVal && newVal !== '-';

  // Format value based on type
  let displayValue = newVal;
  if (type === 'boolean') {
    displayValue = newVal === true ? '<span class="badge success">Yes</span>' :
                   newVal === false ? '<span class="badge warning">No</span>' :
                   '<span class="badge">-</span>';
  } else if (type === 'url' && newVal !== '-') {
    displayValue = `<a href="${newVal}" target="_blank" style="font-size: 11px;">${newVal.substring(0, 40)}...</a>`;
  }

  // Add change indicator styling
  const changeIndicator = hasChange
    ? '<span style="color: #10b981; font-weight: bold; margin-left: 8px;">●</span>'
    : '';

  return `
    <div class="result-item" style="${hasChange ? 'background: #ecfdf5; border-left: 3px solid #10b981;' : ''}">
      <div class="label">${label}${changeIndicator}</div>
      <div class="value">
        ${hasChange ? `<span style="text-decoration: line-through; color: #9ca3af; margin-right: 8px;">${current}</span>` : ''}
        ${displayValue}
      </div>
    </div>
  `;
}
```

Visual design:
- Changed fields: Green background (#ecfdf5), green left border, green dot indicator after label
- Changed fields: Show old value with strikethrough, then arrow, then new value
- Unchanged fields: Normal styling, just show current value
- All fields always visible (even if no change) for full transparency
  </action>
  <verify>
Grep for renderFieldWithChange: `grep -n "renderFieldWithChange" public/index.html`
Should show function definition and 9 usages (one per field).
  </verify>
  <done>Lookup results display all 9 Salesforce enrichment fields with green highlighting for changed values and strikethrough for old values</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Enhanced lookup results showing all Salesforce enrichment fields with change preview</what-built>
  <how-to-verify>
    1. Run: `npm run dev` (if not already running)
    2. Visit: http://localhost:4900/dashboard
    3. Navigate to "Manual Enrichment" tab
    4. Enter a Salesforce Lead ID that exists (e.g., from KPIs recent enrichments)
    5. Click "Lookup Lead"
    6. Verify results show:
       - "Salesforce Lead Data" section (existing - 7 basic fields)
       - **NEW: "Fields That Will Be Updated (Preview)" section with 9 enrichment fields**
       - Fields with changes: Green background, green dot, old value strikethrough → new value
       - Fields without changes: Normal styling, current value only
       - All 9 fields always visible
    7. Test with multiple leads:
       - Already enriched lead (should show mostly "no change")
       - Never enriched lead (should show many changes)
    8. Verify field types render correctly:
       - Booleans: Yes/No badges
       - URLs: Clickable links
       - Text: Plain display
    9. Verify no console errors
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] lookupLead() makes preview enrichment call with update_salesforce=false
- [ ] Computed Salesforce field values stored in newSalesforceFields object
- [ ] renderFieldWithChange() helper function exists
- [ ] All 9 Salesforce enrichment fields displayed in lookup results
- [ ] Changed fields have green highlighting and change indicators
- [ ] Old values shown with strikethrough, new values prominent
- [ ] Unchanged fields display normally without visual noise
- [ ] User verified change highlighting works correctly
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Lookup results show all 9 Salesforce enrichment fields
- Change highlighting clearly indicates which fields will be updated
- No errors introduced
- User has visually verified change preview accuracy
- Phase 3 complete (only 1 plan in this phase)
</success_criteria>

<output>
After completion, create `.planning/phases/03-manual-enrichment-enhancement/03-01-SUMMARY.md`:

---
phase: 03-manual-enrichment-enhancement
plan: 03-01
subsystem: dashboard-ui
requires:
  - 02-01
  - 02-02
  - 02-03
provides:
  - Enrichment field preview pattern
  - Change highlighting pattern
affects:
  - 04-01 (GMB search improvements will benefit from field preview)
tags:
  - manual-enrichment
  - ui-transparency
  - change-preview
key-decisions:
  - Used update_salesforce=false flag to get enrichment preview without Salesforce write
  - Implemented client-side field mapping matching salesforceFieldMapper.ts logic
  - Green highlighting for changed fields to draw attention without overwhelming
  - Always show all 9 fields for full transparency (even if no change)
key-files:
  - public/index.html
tech-stack:
  added: []
  patterns:
    - Enrichment preview pattern (enrich with update_salesforce=false)
    - Change highlighting with visual indicators (strikethrough old, highlight new)
patterns-established:
  - renderFieldWithChange() helper for consistent change display
  - Green background + left border + dot indicator for changed fields
  - Strikethrough old value → new value for clear before/after
next-phase-readiness:
  - Phase 3 complete - manual enrichment UI enhanced
  - Ready to start Phase 4: GMB Match Rate Optimization
---

# Phase 3 Plan 1: Manual Enrichment Field Preview Summary

**Enhanced manual enrichment with full field visibility and change highlighting**

## Accomplishments

- Added enrichment preview fetch (update_salesforce=false) to lookupLead()
- Computed all 9 Salesforce enrichment field values client-side
- Created renderFieldWithChange() helper for consistent change display
- Displayed all enrichment fields in lookup results with change indicators
- Green highlighting for changed fields (background, border, dot indicator)
- Strikethrough old values with prominent new values for clear before/after comparison

## Files Created/Modified

- [public/index.html](public/index.html) - Enhanced lookupLead() and added renderFieldWithChange() helper

## Decisions Made

- Reused existing /api/enrich-by-id endpoint with update_salesforce=false for preview (no new endpoint needed)
- Implemented field mapping logic client-side (duplicates salesforceFieldMapper.ts but avoids backend changes)
- Always show all 9 fields for transparency (even if unchanged)
- Green visual indicators for changes (intuitive, matches success theme)

## Issues Encountered

None

## Verification

- User confirmed all 9 fields display correctly in lookup results
- User verified change highlighting works for both enriched and unenriched leads
- User verified field types (boolean, text, URL) render correctly

## Next Step

Phase 3 complete! Ready for Phase 4: GMB Match Rate Optimization
</output>
