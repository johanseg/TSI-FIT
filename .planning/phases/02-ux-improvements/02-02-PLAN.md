---
phase: 02-ux-improvements
plan: 02-02
type: execute
---

<objective>
Add pagination controls to the Recent Enrichments table in the KPIs (auto-enrichment) view to prevent performance issues when displaying large datasets.

Purpose: Improve page load performance and user experience by limiting the number of enrichments shown at once, using the existing pagination pattern from unenriched leads view.
Output: Recent Enrichments table with pagination controls (Previous/Next buttons, page indicator, 100 records per page)
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/STRUCTURE.md
@.planning/phases/02-ux-improvements/02-01-SUMMARY.md
@public/index.html

**Established patterns:**
- Unenriched leads pagination (lines 765-1916): Global state object, page navigation functions, Previous/Next buttons
- Pagination state structure: `{ currentPage, pageSize, totalCount, totalPages }`
- Backend supports limit/offset parameters on dashboard endpoints

**Current state:**
- Recent Enrichments table (lines 1459-1489) displays ALL enrichments from `recent_enrichments` array
- No pagination controls exist for this view
- KPIs endpoint at `/api/dashboard/enrichment-kpis` returns full recent_enrichments array

**Constraining decisions:**
- Phase 1: Preserve monolithic architecture (no refactoring, incremental improvements only)
- Use existing pagination pattern from unenriched leads view
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pagination state and update loadKPIs() function</name>
  <files>public/index.html</files>
  <action>
Add a new global pagination state object for KPIs enrichments right after the existing unenrichedPagination object (around line 773):

```javascript
let kpiEnrichmentsPagination = {
  currentPage: 1,
  pageSize: 100,
  totalCount: 0,
  totalPages: 0
};
```

Then modify the loadKPIs() function (line 1199) to:
1. Accept an optional page parameter: `async function loadKPIs(page = 1)`
2. Calculate offset: `const offset = (page - 1) * kpiEnrichmentsPagination.pageSize;`
3. Append limit/offset parameters to the API URL: `/api/dashboard/enrichment-kpis?period=${period}&limit=${kpiEnrichmentsPagination.pageSize}&offset=${offset}`
4. Update pagination state after successful fetch:
   ```javascript
   kpiEnrichmentsPagination.currentPage = page;
   kpiEnrichmentsPagination.totalCount = data.total_enrichments || data.recent_enrichments.length;
   kpiEnrichmentsPagination.totalPages = Math.ceil(kpiEnrichmentsPagination.totalCount / kpiEnrichmentsPagination.pageSize);
   ```
5. Update the onchange handler for kpiDateRange selector to call `loadKPIs(1)` instead of `loadKPIs()`

Do NOT modify the renderKPIs() function yet - just the loadKPIs() function and state management.
  </action>
  <verify>
Grep for kpiEnrichmentsPagination: `grep -n "kpiEnrichmentsPagination" public/index.html`
Should show state declaration and usage in loadKPIs function.
  </verify>
  <done>Pagination state exists, loadKPIs() accepts page parameter and updates state</done>
</task>

<task type="auto">
  <name>Task 2: Add pagination controls to Recent Enrichments table</name>
  <files>public/index.html</files>
  <action>
In the renderKPIs() function (around line 1489, after the Recent Enrichments table closing tag), add pagination controls using the same HTML structure as unenriched leads pagination (line 1005):

```javascript
<!-- Pagination Controls -->
${kpiEnrichmentsPagination.totalPages > 1 ? `
  <div class="pagination-controls" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
    <button
      onclick="goToKPIEnrichmentsPage(${kpiEnrichmentsPagination.currentPage - 1})"
      ${kpiEnrichmentsPagination.currentPage === 1 ? 'disabled' : ''}
      style="padding: 8px 16px; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: ${kpiEnrichmentsPagination.currentPage === 1 ? 'not-allowed' : 'pointer'}; opacity: ${kpiEnrichmentsPagination.currentPage === 1 ? '0.5' : '1'};"
    >
      ← Previous
    </button>
    <div style="font-size: 14px; color: #6b7280;">
      Page ${kpiEnrichmentsPagination.currentPage} of ${kpiEnrichmentsPagination.totalPages}
      (${kpiEnrichmentsPagination.totalCount.toLocaleString()} total enrichments)
    </div>
    <button
      onclick="goToKPIEnrichmentsPage(${kpiEnrichmentsPagination.currentPage + 1})"
      ${kpiEnrichmentsPagination.currentPage === kpiEnrichmentsPagination.totalPages ? 'disabled' : ''}
      style="padding: 8px 16px; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: ${kpiEnrichmentsPagination.currentPage === kpiEnrichmentsPagination.totalPages ? 'not-allowed' : 'pointer'}; opacity: ${kpiEnrichmentsPagination.currentPage === kpiEnrichmentsPagination.totalPages ? '0.5' : '1'};"
    >
      Next →
    </button>
  </div>
` : ''}
```

Then add the navigation function after renderKPIs() (around line 1495):

```javascript
function goToKPIEnrichmentsPage(page) {
  if (page < 1 || page > kpiEnrichmentsPagination.totalPages) return;
  loadKPIs(page);
}
```

Do NOT modify the backend endpoint - it should already support limit/offset parameters (if not, this will be discovered during verification).
  </action>
  <verify>
Grep for goToKPIEnrichmentsPage: `grep -n "goToKPIEnrichmentsPage" public/index.html`
Should show function definition and usage in pagination controls.
  </verify>
  <done>Pagination controls visible when totalPages > 1, navigation function exists</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Pagination controls for Recent Enrichments table in KPIs view</what-built>
  <how-to-verify>
    1. Run: `npm run dev` (if not already running)
    2. Visit: http://localhost:4900/dashboard
    3. Navigate to KPIs tab
    4. Test pagination:
       - If you have >100 enrichments: verify pagination controls appear
       - Click "Next" button and verify page increments
       - Verify table shows different enrichments (next 100 records)
       - Click "Previous" button and verify return to page 1
       - Verify page counter shows correct "Page X of Y"
       - Verify total enrichments count is accurate
    5. If you have <100 enrichments:
       - Verify NO pagination controls appear (since totalPages = 1)
       - Note: To test pagination, you may need to select a longer date range (e.g., "last_30_days" or "this_year")
    6. Test date selector interaction:
       - Change date range and verify pagination resets to page 1
       - Verify pagination state updates correctly for new date range
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix (e.g., "backend doesn't support limit/offset yet")</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] kpiEnrichmentsPagination state object exists
- [ ] loadKPIs() accepts page parameter and updates pagination state
- [ ] Pagination controls render when totalPages > 1
- [ ] Previous/Next buttons navigate correctly
- [ ] Page counter shows accurate information
- [ ] Date range changes reset pagination to page 1
- [ ] User verified pagination works correctly
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Pagination controls visible and functional for Recent Enrichments table
- No errors introduced
- User has visually verified pagination behavior
</success_criteria>

<output>
After completion, create `.planning/phases/02-ux-improvements/02-02-SUMMARY.md`:

---
phase: 02-ux-improvements
plan: 02-02
subsystem: dashboard-ui
requires:
  - 02-01
provides:
  - KPIs pagination pattern
affects:
  - 02-03
tags:
  - ui-performance
  - pagination
key-decisions:
  - Reused unenrichedPagination pattern for consistency
  - Set page size to 100 to match existing pattern
  - Conditionally show controls only when totalPages > 1
key-files:
  - public/index.html
tech-stack:
  added: []
  patterns:
    - Pagination pattern for enrichment tables
patterns-established:
  - Global pagination state objects for each paginated view
  - goToXPage() navigation functions
  - Previous/Next button controls with disabled states
---

# Phase 2 Plan 2: Add Pagination to KPIs Summary

**Implemented pagination for Recent Enrichments table to handle large datasets efficiently**

## Accomplishments

- Added kpiEnrichmentsPagination state object for pagination management
- Modified loadKPIs() to accept page parameter and call API with limit/offset
- Implemented pagination controls (Previous/Next buttons, page counter) matching unenriched leads pattern
- Pagination controls conditionally render only when totalPages > 1
- Date range selector changes reset pagination to page 1

## Files Created/Modified

- [public/index.html](public/index.html) - Added KPIs pagination state, controls, and navigation function

## Decisions Made

- Reused existing pagination pattern from unenriched leads view for UI consistency
- Set page size to 100 records to match existing pattern
- Hide pagination controls when all data fits on one page (better UX)

## Issues Encountered

[Document any backend issues if API didn't already support limit/offset, or "None" if it worked]

## Verification

- User confirmed pagination controls appear when >100 enrichments exist
- User verified Previous/Next navigation works correctly
- User verified page counter shows accurate counts
- User verified date range changes reset pagination

## Next Step

Ready for [02-03-PLAN.md](.planning/phases/02-ux-improvements/02-03-PLAN.md) (Convert Lead IDs to links and filter Unknown leads)
</output>
