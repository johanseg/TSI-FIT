# Codebase Structure

**Analysis Date:** 2026-01-08

## Directory Layout

```
TSI-Fit Score/
├── src/                    # TypeScript source code
│   ├── index.ts           # Express app, routes, main logic (1889 lines)
│   ├── types/             # TypeScript interfaces
│   ├── services/          # Business logic and external integrations
│   └── utils/             # Cross-cutting concerns
├── migrations/            # Database schema (PostgreSQL)
├── public/                # Dashboard frontend (static HTML)
├── dist/                  # Compiled JavaScript (build output)
├── package.json           # Dependencies and scripts
├── tsconfig.json          # TypeScript configuration
├── CLAUDE.md              # Project documentation
├── README.md              # Setup and deployment guide
└── .env.example           # Environment variable template
```

## Directory Purposes

**src/**
- Purpose: All TypeScript source code
- Contains: Main application logic, services, types, utilities
- Key files:
  - `index.ts` - Express server, routes, middleware (1889 lines)
- Subdirectories: `types/`, `services/`, `utils/`

**src/types/**
- Purpose: TypeScript interface definitions
- Contains: `lead.ts` - All data contracts (lead payloads, enrichment data, Salesforce fields)
- Key files:
  - `lead.ts` - 213 lines of interfaces and type unions
- Subdirectories: None

**src/services/**
- Purpose: Business logic and external API integrations
- Contains: Service classes for enrichment sources, Salesforce operations, field mapping
- Key files:
  - `googlePlaces.ts` - Google Places API integration, GMB matching
  - `peopleDataLabs.ts` - PDL API integration
  - `websiteTech.ts` - Puppeteer-based tech detection
  - `salesforce.ts` - Salesforce OAuth + CRUD operations
  - `fitScore.ts` - Fit score calculation algorithm
  - `salesforceFieldMapper.ts` - Data transformation to SF types
  - `dashboardStats.ts` - Analytics and reporting queries
  - `clay.ts` - Legacy service (kept for backwards compatibility)
- Subdirectories: None

**src/utils/**
- Purpose: Cross-cutting infrastructure utilities
- Contains: Logger, retry logic, circuit breaker
- Key files:
  - `logger.ts` - Winston logger with sensitive data redaction
  - `retry.ts` - Exponential backoff retry logic
  - `circuitBreaker.ts` - Circuit breaker pattern implementation
- Subdirectories: None

**migrations/**
- Purpose: Database schema definitions and migrations
- Contains: Numbered SQL migration files
- Key files:
  - `001_create_leads_table.sql`
  - `002_create_enrichments_table.sql`
  - `003_salesforce_aligned_fields.sql`
  - `004_add_utm_and_address_fields.sql`
  - `005_drop_fit_tier_column.sql`
  - `006_fix_enrichments_lead_id.sql`
  - `007_replace_clay_with_pdl.sql`
- Subdirectories: None

**public/**
- Purpose: Static HTML dashboard frontend
- Contains: `index.html` - Dashboard UI served on `/dashboard` route
- Key files: `index.html`
- Subdirectories: None

**dist/**
- Purpose: Compiled JavaScript output from TypeScript
- Contains: Build artifacts (gitignored)
- Generated by: `npm run build` (tsc compiler)

## Key File Locations

**Entry Points:**
- `src/index.ts` - Main Express server (1889 lines)
- `dist/index.js` - Compiled production entry point

**Configuration:**
- `tsconfig.json` - TypeScript compiler configuration (strict mode, ES2022 target)
- `package.json` - Dependencies, scripts, Node version requirement
- `.env.example` - Environment variable template (all required vars)

**Core Logic:**
- `src/services/fitScore.ts` - Fit score calculation algorithm
- `src/services/salesforceFieldMapper.ts` - Field transformation logic
- `src/services/googlePlaces.ts` - GMB matching and location detection

**Testing:**
- Not detected - No test files present

**Documentation:**
- `CLAUDE.md` - Comprehensive project documentation
- `README.md` - Setup and deployment guide
- `.env.example` - Configuration reference

## Naming Conventions

**Files:**
- camelCase for all TypeScript files: `googlePlaces.ts`, `fitScore.ts`, `retry.ts`
- PascalCase class names inside camelCase filenames
- Migration files: Numbered prefix with descriptive snake_case: `001_create_leads_table.sql`

**Directories:**
- Lowercase with optional hyphens: `src/`, `migrations/`, `public/`
- Plural for collections: `services/`, `utils/`, `types/`, `migrations/`

**Special Patterns:**
- No `index.ts` barrel exports in subdirectories
- Service files named after their primary class: `GooglePlacesService` in `googlePlaces.ts`

## Where to Add New Code

**New Enrichment Source:**
- Primary code: `src/services/{source}.ts` (e.g., `clearbit.ts`)
- Types: Add interfaces to `src/types/lead.ts` (e.g., `ClearbitData`)
- Integration: Update `src/index.ts` enrichment pipeline
- Field mapping: Update `src/services/salesforceFieldMapper.ts` if needed

**New API Endpoint:**
- Definition: Add route handler in `src/index.ts`
- Business logic: Extract to `src/services/` if complex
- Validation: Define Zod schema in `src/index.ts`

**New Utility/Helper:**
- Implementation: `src/utils/{name}.ts`
- Pattern: Export pure functions or classes
- Examples: Circuit breaker, retry logic, logger

**New Database Migration:**
- Implementation: `migrations/{nextNumber}_{description}.sql`
- Pattern: Sequential numbering (001, 002, ...)
- Must be run manually (no auto-migration)

**New Salesforce Field:**
- Type definition: Add to `src/types/lead.ts` (interface or picklist type)
- Mapping logic: Update `src/services/salesforceFieldMapper.ts`
- Database: Add migration in `migrations/`

## Special Directories

**dist/**
- Purpose: Build artifacts (TypeScript → JavaScript)
- Source: Generated by `tsc` via `npm run build`
- Committed: No (in `.gitignore`)

**node_modules/**
- Purpose: npm dependencies
- Source: Installed via `npm install`
- Committed: No (in `.gitignore`)

**.puppeteer_cache/**
- Purpose: Chromium browser binaries for Puppeteer
- Source: Downloaded by Puppeteer during npm install
- Committed: No (in `.gitignore`)

---

*Structure analysis: 2026-01-08*
*Update when directory structure changes*
